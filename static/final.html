<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KundliSage</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-primary: #000000;
            --text-primary: #F5F5F5;
            --text-secondary: #F2F2F7;
            --input-background: #2A2A2A;
            --border-color: #2B2B2B;
            --accent-color: #8E8E93;
            --button-hover: #333333;
        }

        * {
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(to bottom, #000000, #1A1A1A);
            color: var(--text-primary);
            font-family: 'Plus Jakarta Sans', Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
        }

        h1, h2, h3 {
            color: var(--text-primary);
            font-weight: 600;
        }

        input, select, textarea {
            background-color: var(--input-background);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-primary);
            padding: 12px 16px;
            margin-bottom: 16px;
            width: 100%;
            font-family: 'Plus Jakarta Sans', Arial, sans-serif;
        }

        button {
            background-color: var(--input-background);
            color: var(--text-primary);
            border: none;
            border-radius: 16px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--button-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 24px;
            background-color: var(--background-primary);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0px 1px 2px rgba(10, 10, 10, 0.05);
        }

        .form-container {
            box-shadow: 0px 4px 24px rgba(0, 0, 0, 0.2);
            border-radius: 25px;
            padding: 24px;
            background-color: #1A1A1A;
            margin-top: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .timezone-options, .language-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .option-button {
            background-color: var(--input-background);
            border: 1px solid var(--border-color);
            border-radius: 80px;
            padding: 8px 16px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .option-button.selected {
            background-color: var(--accent-color);
            color: var(--background-primary);
        }

        .greeting {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .search-container {
            position: relative;
            width: 100%;
        }

        .search-input-container {
            display: flex;
            gap: 8px;
        }

        .search-button {
            flex-shrink: 0;
            padding: 12px 16px;
            border-radius: 16px;
        }

        .dropdown-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--input-background);
            border: 1px solid var(--border-color);
            border-radius: 0 0 16px 16px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .dropdown-results.show {
            display: block;
        }

        .city-option {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .city-option:hover {
            background-color: var(--button-hover);
        }

        .city-name {
            font-weight: 600;
        }

        .city-details {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .selected-location {
            margin-top: 8px;
            padding: 8px 12px;
            background-color: rgba(142, 142, 147, 0.2);
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .selected-location.show {
            display: block;
        }

        /* Chat Container Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            margin-top: 30px;
            border-radius: 16px;
            overflow: hidden;
            background-color: #1A1A1A;
            box-shadow: 0px 4px 24px rgba(0, 0, 0, 0.2);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-input-container {
            display: flex;
            padding: 12px;
            background-color: #2A2A2A;
            border-top: 1px solid var(--border-color);
        }

        .chat-input-container input {
            flex: 1;
            background-color: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 0;
            padding: 8px 12px;
        }

        .chat-input-container input:focus {
            outline: none;
        }

        .send-chat-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--input-background);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            padding: 0;
            margin-left: 8px;
        }

        .send-chat-button:hover {
            background-color: var(--button-hover);
        }

        .send-chat-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Message Styles */
        .user-message, .ai-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            margin-bottom: 8px;
        }

        .user-message {
            align-self: flex-end;
            background-color: #2A2A2A;
            color: var(--text-primary);
            margin-left: auto;
        }

        .ai-message {
            align-self: flex-start;
            background-color: #1A1A1A;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            margin-right: auto;
        }

        .message-content {
            word-break: break-word;
            line-height: 1.5;
        }

        /* Loading Animation */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--text-primary);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-message {
            margin-top: 12px;
            color: var(--text-secondary);
            font-size: 14px;
            text-align: center;
            min-height: 20px;
        }

        .save-button {
            display: block;
            width: 100%;
            margin-top: 20px;
            padding: 14px;
            border-radius: 16px;
            background-color: var(--accent-color);
            color: var(--background-primary);
            font-weight: 600;
            text-align: center;
        }

        .save-button:hover {
            background-color: #A0A0A7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>KundliSage</h1>
        </div>
        
        <div class="form-container">
            <div class="greeting">
                <p>Namaste! To get your birth chart, I need the following details.</p>
            </div>

            <div class="form-group">
                <label for="name">Your Name:</label>
                <input type="text" id="name" name="name">
            </div>
            
            <div class="form-group">
                <label for="birthdate">Birth Date-Time:</label>
                <input type="datetime-local" id="birthdate" name="birthdate">
            </div>
            
            <div class="form-group">
                <label for="citySearch">Birthplace:</label>
                <div class="search-container">
                    <div class="search-input-container">
                        <input type="text" id="citySearch" placeholder="Type to search cities...">
                        <button id="searchBtn" class="search-button">Search</button>
                    </div>
                    <div id="cityResults" class="dropdown-results"></div>
                    <div id="selectedLocation" class="selected-location"></div>
                </div>
                <input type="hidden" id="birthplace" name="birthplace">
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
            </div>
            
            <div class="form-group">
                <label>Timezone:</label>
                <div class="timezone-options">
                    <button class="option-button timezone-option selected" data-value="5.5" type="button">IST (UTC+5:30)</button>
                    <button class="option-button timezone-option" data-value="0" type="button">UTC (GMT+0)</button>
                    <button class="option-button timezone-option" data-value="1" type="button">CET (UTC+1)</button>
                    <button class="option-button timezone-option" data-value="3.5" type="button">Iran (UTC+3:30)</button>
                    <button class="option-button timezone-option" data-value="8" type="button">China (UTC+8)</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Language:</label>
                <div class="language-options">
                    <button class="option-button language-option selected" data-value="en" type="button">English</button>
                    <button class="option-button language-option" data-value="hi" type="button">Hindi</button>
                    <button class="option-button language-option" data-value="bn" type="button">Bengali</button>
                    <button class="option-button language-option" data-value="ta" type="button">Tamil</button>
                </div>
            </div>
            
            <button id="saveDetailsBtn" class="save-button" type="button">Save Details</button>
            
            <div id="status" class="status-message"></div>
            
            <!-- Hidden form fields -->
            <input type="hidden" id="tz" value="5.5">
            <input type="hidden" id="lang" value="en">
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="ai-message">
                    <div class="message-content">
                        Namaste! I'm your KundliSage assistant. Once you save your birth details, you can ask me questions about your birth chart and astrological insights.
                    </div>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="queryInput" placeholder="Save your details first..." disabled>
                <button id="sendBtn" class="send-chat-button" disabled>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.08801 1.082C1.49401 0.784999 0.835514 1.35 1.03851 1.9825L2.46751 6.424C2.49561 6.51131 2.54718 6.58921 2.61658 6.64918C2.68599 6.70915 2.77055 6.74887 2.86101 6.764L8.79551 7.7535C9.07401 7.8 9.07401 8.2 8.79551 8.2465L2.86151 9.2355C2.77096 9.25054 2.68629 9.29023 2.61679 9.3502C2.54729 9.41017 2.49565 9.48812 2.46751 9.5755L1.03851 14.0185C0.835014 14.651 1.49351 15.216 2.08801 14.919L14.585 8.6715C15.138 8.395 15.138 7.6065 14.585 7.3295L2.08801 1.082Z" fill="#F5F5F5"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        let detailsSaved = false;
        let locationSelected = false;
        
        function getLocation() {
            const status = document.getElementById("status");
            if (navigator.geolocation) {
                status.textContent = "Locating...";
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        document.getElementById("latitude").value = latitude;
                        document.getElementById("longitude").value = longitude;
                        
                        // Set a default birthplace name based on coordinates
                        document.getElementById("birthplace").value = "Current Location";
                        
                        // Show the selected location
                        displaySelectedLocation("Current Location", latitude, longitude);
                        
                        status.textContent = "Location found!";
                        console.log(`Location: ${latitude}, ${longitude}`);
                        
                        // Mark location as selected
                        locationSelected = true;
                    },
                    function(error) {
                        status.textContent = "Geolocation failed. Please search your birthplace.";
                        document.getElementById("latitude").value = "26.46523000";
                        document.getElementById("longitude").value = "80.34975000";
                        
                        // Set a default birthplace name
                        document.getElementById("birthplace").value = "Kanpur, Uttar Pradesh, India";
                        
                        // Show the selected location
                        displaySelectedLocation("Kanpur, Uttar Pradesh, India", "26.46523000", "80.34975000");
                        
                        // Mark location as selected
                        locationSelected = true;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                status.textContent = "Geolocation not supported. Using default location.";
                document.getElementById("latitude").value = "26.46523000";
                document.getElementById("longitude").value = "80.34975000";
                
                // Set a default birthplace name
                document.getElementById("birthplace").value = "Kanpur, Uttar Pradesh, India";
                
                // Show the selected location
                displaySelectedLocation("Kanpur, Uttar Pradesh, India", "26.46523000", "80.34975000");
                
                // Mark location as selected
                locationSelected = true;
            }
        }

        function searchCities(query) {
            const status = document.getElementById("status");
            const cityResultsDiv = document.getElementById('cityResults');
            
            status.textContent = "Searching location...";
            cityResultsDiv.innerHTML = '<div class="city-option">Searching...</div>';
            cityResultsDiv.classList.add('show');
            
            fetch(`/geo-search?city=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 200 && data.locations.length > 0) {
                        // Display results in dropdown
                        cityResultsDiv.innerHTML = '';
                        
                        data.locations.forEach(location => {
                            const cityOption = document.createElement('div');
                            cityOption.className = 'city-option';
                            
                            // Split the full_name to display city name and details separately
                            const nameParts = location.full_name.split(',');
                            const cityName = nameParts[0];
                            const cityDetails = nameParts.slice(1).join(',').trim();
                            
                            cityOption.innerHTML = `
                                <div class="city-name">${cityName}</div>
                                <div class="city-details">${cityDetails}</div>
                            `;
                            
                            // Add click event to select this city
                            cityOption.addEventListener('click', function() {
                                // Set the input value to the selected city name
                                document.getElementById('citySearch').value = cityName;
                                
                                // Set the latitude and longitude in hidden inputs
                                document.getElementById('latitude').value = location.coordinates[0];
                                document.getElementById('longitude').value = location.coordinates[1];
                                
                                // Set the full birthplace value
                                document.getElementById('birthplace').value = location.full_name;
                                
                                // Show the selected location
                                displaySelectedLocation(location.full_name, location.coordinates[0], location.coordinates[1]);
                                
                                // Hide the results dropdown
                                cityResultsDiv.classList.remove('show');
                                
                                status.textContent = `Selected: ${location.full_name}`;
                                
                                // Mark location as selected
                                locationSelected = true;
                            });
                            
                            cityResultsDiv.appendChild(cityOption);
                        });
                    } else {
                        cityResultsDiv.innerHTML = '<div class="city-option">No cities found</div>';
                        status.textContent = "No locations found for this city.";
                    }
                })
                .catch(error => {
                    console.error('Error fetching cities:', error);
                    cityResultsDiv.innerHTML = '<div class="city-option">Error searching cities</div>';
                    status.textContent = "Error fetching location data";
                });
        }
        
        function displaySelectedLocation(name, lat, lon) {
            const selectedLocationDiv = document.getElementById('selectedLocation');
            selectedLocationDiv.innerHTML = `
                <strong>Selected:</strong> ${name}<br>
                <span>Coordinates: ${lat}, ${lon}</span>
            `;
            selectedLocationDiv.classList.add('show');
        }
        
        function appendMessage(content, isUser) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'user-message' : 'ai-message';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = content.replace(/\n/g, '<br>');
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function appendLoadingMessage() {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.id = 'loading-message';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            
            contentDiv.appendChild(spinner);
            contentDiv.appendChild(document.createTextNode('Analyzing your chart...'));
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function removeLoadingMessage() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }
        
        function sendQuery() {
            const queryInput = document.getElementById('queryInput');
            const query = queryInput.value.trim();
            
            if (!query) return;
            
            // Add user message to chat
            appendMessage(query, true);
            
            // Clear input
            queryInput.value = '';
            
            // Show loading message
            appendLoadingMessage();
            
            // Get user details for the prediction API
            const name = document.getElementById('name').value.trim();
            const birthdate = document.getElementById('birthdate').value;
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            const tz = document.getElementById('tz').value;
            const lang = document.getElementById('lang').value;
            
            // Format the data for the prediction API
            const [datePart, timePart] = birthdate.split('T');
            const [year, month, day] = datePart.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            const formattedTime = timePart.substring(0, 5); // HH:MM format
            
            const predictionData = {
                name: name,
                dob: formattedDate,
                tob: formattedTime,
                lat: latitude,
                lon: longitude,
                tz: parseFloat(tz),
                lang: lang,
                query: query
            };
            
            // Send to prediction API
            fetch('/chat/prediction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(predictionData)
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading message
                removeLoadingMessage();
                
                // Display the prediction
                appendMessage(data.prediction, false);
            })
            .catch(error => {
                console.error('Error:', error);
                removeLoadingMessage();
                appendMessage("I'm sorry, I couldn't process your request at this time. Please try again later.", false);
            });
        }
        
        function saveDetails() {
            const name = document.getElementById('name').value.trim();
            const birthdate = document.getElementById('birthdate').value;
            const birthplace = document.getElementById('birthplace').value.trim();
            
            if (!name) {
                document.getElementById('status').textContent = "Please enter your name";
                return;
            }
            
            if (!birthdate) {
                document.getElementById('status').textContent = "Please enter your birth date and time";
                return;
            }
            
            if (!locationSelected) {
                document.getElementById('status').textContent = "Please search and select your birthplace";
                return;
            }
            
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            
            if (!latitude || !longitude) {
                document.getElementById('status').textContent = "Please search and select a valid birthplace";
                return;
            }
            
            detailsSaved = true;
            
            // Enable chat input
            document.getElementById('queryInput').disabled = false;
            document.getElementById('queryInput').placeholder = "Ask about your birth chart...";
            document.getElementById('sendBtn').disabled = false;
            
            // Update status
            document.getElementById('status').textContent = "Details saved successfully! You can now chat with KundliSage.";
            
            // Add confirmation message to chat
            const birthDateTime = new Date(birthdate).toLocaleString();
            const tzValue = document.getElementById('tz').value;
            const langValue = document.getElementById('lang').value;
            
            const confirmationMessage = `
                I've recorded your birth details:
                • Name: ${name}
                • Birth Date & Time: ${birthDateTime}
                • Birthplace: ${birthplace} (${latitude}, ${longitude})
                • Timezone: UTC+${tzValue}
                • Language: ${langValue}
                
                What would you like to know about your birth chart?
            `;
            
            appendMessage(confirmationMessage, false);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Get user's location
            getLocation();
            
            // Handle timezone selection
            const timezoneButtons = document.querySelectorAll('.timezone-option');
            timezoneButtons.forEach(button => {
                button.addEventListener('click', function() {
                    timezoneButtons.forEach(btn => btn.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('tz').value = this.getAttribute('data-value');
                });
            });
            
            // Handle language selection
            const languageButtons = document.querySelectorAll('.language-option');
            languageButtons.forEach(button => {
                button.addEventListener('click', function() {
                    languageButtons.forEach(btn => btn.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('lang').value = this.getAttribute('data-value');
                });
            });
            
            // City search functionality
            const citySearchInput = document.getElementById('citySearch');
            const cityResultsDiv = document.getElementById('cityResults');
            
            let debounceTimer;
            
            // Search button functionality
            document.getElementById('searchBtn').addEventListener('click', function() {
                const query = citySearchInput.value.trim();
                if (query) {
                    searchCities(query);
                }
            });
            
            // Enter key in search input
            citySearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (query) {
                        searchCities(query);
                    }
                    e.preventDefault();
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!citySearchInput.contains(e.target) && 
                    !cityResultsDiv.contains(e.target) && 
                    !document.getElementById('searchBtn').contains(e.target)) {
                    cityResultsDiv.classList.remove('show');
                }
            });
            
            // Save details button
            document.getElementById('saveDetailsBtn').addEventListener('click', saveDetails);
            
            // Send button
            document.getElementById('sendBtn').addEventListener('click', sendQuery);
            
            // Enter key in query input
            document.getElementById('queryInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendQuery();
                }
            });
        });
    </script>
</body>
</html>
